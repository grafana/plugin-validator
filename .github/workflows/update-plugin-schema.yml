name: Update Grafana Plugin Schema

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

jobs:
  update-schema:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true

      - name: Download latest schema
        run: |
          curl -sSL https://raw.githubusercontent.com/grafana/grafana/main/docs/sources/developers/plugins/plugin.schema.json \
            -o /tmp/new-schema.json

      - name: Check if schema changed
        id: check
        run: |
          if ! diff -q config/plugin.schema.json /tmp/new-schema.json > /dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Schema is already up to date"
          fi

      - name: Update schema
        if: steps.check.outputs.changed == 'true'
        run: |
          cp /tmp/new-schema.json config/plugin.schema.json
          cp /tmp/new-schema.json pkg/analysis/passes/metadatavalid/testdata/schema.json

      - name: Create Pull Request
        if: steps.check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          commit-message: "chore: update Grafana plugin schema"
          title: "chore: update Grafana plugin schema"
          body: |
            Automated update of the Grafana plugin schema from upstream.

            **Source:** https://github.com/grafana/grafana/blob/main/docs/sources/developers/plugins/plugin.schema.json
          branch: automation/update-plugin-schema
          labels: dependencies
          delete-branch: true
          sign-commits: true
